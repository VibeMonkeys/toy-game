export class MiniGameSystem {
    constructor(canvas, ctx, audioManager) {
        this.canvas = canvas;
        this.ctx = ctx;
        this.audioManager = audioManager;

        this.isVisible = false;
        this.currentGame = null;
        this.gameMenuIndex = 0;
        this.games = [
            { name: 'Î©îÎ™®Î¶¨ Îß§Ïπò', id: 'memory', icon: 'üß†' },
            { name: 'Ïä§ÎÑ§Ïù¥ÌÅ¨ Í≤åÏûÑ', id: 'snake', icon: 'üêç' },
            { name: 'ÎÇòÍ∞ÄÍ∏∞', id: 'exit', icon: 'üö™' }
        ];

        // Î©îÎ™®Î¶¨ Í≤åÏûÑ ÏÉÅÌÉú
        this.memoryGame = {
            cards: [],
            flippedCards: [],
            matchedPairs: 0,
            totalPairs: 8,
            gameStarted: false,
            gameWon: false,
            flipDelay: false
        };

        // Ïä§ÎÑ§Ïù¥ÌÅ¨ Í≤åÏûÑ ÏÉÅÌÉú
        this.snakeGame = {
            snake: [{ x: 10, y: 10 }],
            food: { x: 15, y: 15 },
            direction: { x: 1, y: 0 },
            score: 0,
            gameStarted: false,
            gameOver: false,
            lastUpdate: 0,
            speed: 200
        };

        this.initializeMemoryCards();
    }

    initializeMemoryCards() {
        const symbols = ['üéì', 'üíª', 'üìö', 'üèÜ', '‚≠ê', 'üî•', 'üí°', 'üéØ'];
        const cardPairs = [...symbols, ...symbols];

        // Ïπ¥Îìú ÏÑûÍ∏∞
        for (let i = cardPairs.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [cardPairs[i], cardPairs[j]] = [cardPairs[j], cardPairs[i]];
        }

        // 4x4 Í∑∏Î¶¨ÎìúÎ°ú Î∞∞Ïπò
        this.memoryGame.cards = [];
        for (let i = 0; i < 16; i++) {
            this.memoryGame.cards.push({
                symbol: cardPairs[i],
                flipped: false,
                matched: false,
                x: (i % 4) * 120 + 300,
                y: Math.floor(i / 4) * 100 + 200
            });
        }
    }

    show() {
        this.isVisible = true;
        this.currentGame = null;
        this.gameMenuIndex = 0;
    }

    hide() {
        this.isVisible = false;
        this.currentGame = null;
        this.resetGames();
    }

    resetGames() {
        // Î©îÎ™®Î¶¨ Í≤åÏûÑ Î¶¨ÏÖã
        this.memoryGame.matchedPairs = 0;
        this.memoryGame.gameStarted = false;
        this.memoryGame.gameWon = false;
        this.memoryGame.flippedCards = [];
        this.memoryGame.flipDelay = false;
        this.initializeMemoryCards();

        // Ïä§ÎÑ§Ïù¥ÌÅ¨ Í≤åÏûÑ Î¶¨ÏÖã
        this.snakeGame.snake = [{ x: 10, y: 10 }];
        this.snakeGame.food = { x: 15, y: 15 };
        this.snakeGame.direction = { x: 1, y: 0 };
        this.snakeGame.score = 0;
        this.snakeGame.gameStarted = false;
        this.snakeGame.gameOver = false;
        this.snakeGame.lastUpdate = 0;
    }

    handleKeyDown(event) {
        if (!this.isVisible) return null;

        if (this.currentGame === null) {
            // Í≤åÏûÑ Î©îÎâ¥
            switch (event.key) {
                case 'ArrowUp':
                    this.gameMenuIndex = (this.gameMenuIndex - 1 + this.games.length) % this.games.length;
                    this.audioManager?.playUIHover();
                    break;
                case 'ArrowDown':
                    this.gameMenuIndex = (this.gameMenuIndex + 1) % this.games.length;
                    this.audioManager?.playUIHover();
                    break;
                case 'Enter':
                case ' ':
                    return this.selectGame();
                case 'Escape':
                    this.hide();
                    return 'close';
            }
        } else if (this.currentGame === 'snake') {
            return this.handleSnakeInput(event);
        } else if (this.currentGame === 'memory') {
            return this.handleMemoryInput(event);
        }

        return null;
    }

    handleMouseClick(event) {
        if (!this.isVisible) return null;

        const rect = this.canvas.getBoundingClientRect();
        const mouseX = event.clientX - rect.left;
        const mouseY = event.clientY - rect.top;

        if (this.currentGame === 'memory') {
            return this.handleMemoryClick(mouseX, mouseY);
        }

        return null;
    }

    selectGame() {
        const selectedGame = this.games[this.gameMenuIndex];

        switch (selectedGame.id) {
            case 'memory':
                this.currentGame = 'memory';
                this.memoryGame.gameStarted = true;
                this.audioManager?.playUIClick();
                break;
            case 'snake':
                this.currentGame = 'snake';
                this.snakeGame.gameStarted = true;
                this.audioManager?.playUIClick();
                break;
            case 'exit':
                this.hide();
                return 'close';
        }

        return null;
    }

    handleMemoryInput(event) {
        if (event.key === 'Escape') {
            this.currentGame = null;
            return null;
        }
        return null;
    }

    handleMemoryClick(mouseX, mouseY) {
        if (this.memoryGame.flipDelay || this.memoryGame.gameWon) return null;

        for (let card of this.memoryGame.cards) {
            if (mouseX >= card.x && mouseX <= card.x + 100 &&
                mouseY >= card.y && mouseY <= card.y + 80) {

                if (!card.flipped && !card.matched && this.memoryGame.flippedCards.length < 2) {
                    card.flipped = true;
                    this.memoryGame.flippedCards.push(card);
                    this.audioManager?.playUIClick();

                    if (this.memoryGame.flippedCards.length === 2) {
                        setTimeout(() => this.checkMemoryMatch(), 1000);
                        this.memoryGame.flipDelay = true;
                    }
                }
                break;
            }
        }

        return null;
    }

    checkMemoryMatch() {
        const [card1, card2] = this.memoryGame.flippedCards;

        if (card1.symbol === card2.symbol) {
            card1.matched = true;
            card2.matched = true;
            this.memoryGame.matchedPairs++;
            this.audioManager?.playGameComplete();

            if (this.memoryGame.matchedPairs === this.memoryGame.totalPairs) {
                this.memoryGame.gameWon = true;
            }
        } else {
            card1.flipped = false;
            card2.flipped = false;
            this.audioManager?.playMenuMove();
        }

        this.memoryGame.flippedCards = [];
        this.memoryGame.flipDelay = false;
    }

    handleSnakeInput(event) {
        if (!this.snakeGame.gameStarted || this.snakeGame.gameOver) {
            if (event.key === 'Enter' || event.key === ' ') {
                this.resetGames();
                this.snakeGame.gameStarted = true;
                return null;
            }
            if (event.key === 'Escape') {
                this.currentGame = null;
                return null;
            }
            return null;
        }

        switch (event.key) {
            case 'ArrowUp':
                if (this.snakeGame.direction.y !== 1) {
                    this.snakeGame.direction = { x: 0, y: -1 };
                }
                break;
            case 'ArrowDown':
                if (this.snakeGame.direction.y !== -1) {
                    this.snakeGame.direction = { x: 0, y: 1 };
                }
                break;
            case 'ArrowLeft':
                if (this.snakeGame.direction.x !== 1) {
                    this.snakeGame.direction = { x: -1, y: 0 };
                }
                break;
            case 'ArrowRight':
                if (this.snakeGame.direction.x !== -1) {
                    this.snakeGame.direction = { x: 1, y: 0 };
                }
                break;
            case 'Escape':
                this.currentGame = null;
                break;
        }

        return null;
    }

    update() {
        if (!this.isVisible) return;

        if (this.currentGame === 'snake' && this.snakeGame.gameStarted && !this.snakeGame.gameOver) {
            const now = Date.now();
            if (now - this.snakeGame.lastUpdate > this.snakeGame.speed) {
                this.updateSnake();
                this.snakeGame.lastUpdate = now;
            }
        }
    }

    updateSnake() {
        const head = { ...this.snakeGame.snake[0] };
        head.x += this.snakeGame.direction.x;
        head.y += this.snakeGame.direction.y;

        // Î≤Ω Ï∂©Îèå Ï≤¥ÌÅ¨
        if (head.x < 0 || head.x >= 30 || head.y < 0 || head.y >= 20) {
            this.snakeGame.gameOver = true;
            return;
        }

        // ÏûêÍ∏∞ ÏûêÏã† Ï∂©Îèå Ï≤¥ÌÅ¨
        for (let segment of this.snakeGame.snake) {
            if (head.x === segment.x && head.y === segment.y) {
                this.snakeGame.gameOver = true;
                return;
            }
        }

        this.snakeGame.snake.unshift(head);

        // ÏùåÏãù Î®πÍ∏∞ Ï≤¥ÌÅ¨
        if (head.x === this.snakeGame.food.x && head.y === this.snakeGame.food.y) {
            this.snakeGame.score += 10;
            this.generateSnakeFood();
            this.audioManager?.playItemCollect();
        } else {
            this.snakeGame.snake.pop();
        }
    }

    generateSnakeFood() {
        do {
            this.snakeGame.food = {
                x: Math.floor(Math.random() * 30),
                y: Math.floor(Math.random() * 20)
            };
        } while (this.snakeGame.snake.some(segment =>
            segment.x === this.snakeGame.food.x && segment.y === this.snakeGame.food.y
        ));
    }

    draw() {
        if (!this.isVisible) return;

        // Î∞∞Í≤Ω
        this.ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

        if (this.currentGame === null) {
            this.drawGameMenu();
        } else if (this.currentGame === 'memory') {
            this.drawMemoryGame();
        } else if (this.currentGame === 'snake') {
            this.drawSnakeGame();
        }
    }

    drawGameMenu() {
        // Ï†úÎ™©
        this.ctx.fillStyle = '#00ffff';
        this.ctx.font = 'bold 36px monospace';
        this.ctx.textAlign = 'center';
        this.ctx.fillText('üéÆ Ìú¥ÎÑ∑ ÏïÑÏºÄÏù¥Îìú üéÆ', this.canvas.width / 2, 150);

        // Í≤åÏûÑ Î™©Î°ù
        this.ctx.font = 'bold 24px monospace';
        const startY = 250;
        const spacing = 60;

        for (let i = 0; i < this.games.length; i++) {
            const y = startY + i * spacing;
            const isSelected = i === this.gameMenuIndex;

            if (isSelected) {
                // ÏÑ†ÌÉùÎêú Í≤åÏûÑ ÌïòÏù¥ÎùºÏù¥Ìä∏
                this.ctx.fillStyle = 'rgba(0, 255, 255, 0.2)';
                this.ctx.fillRect(this.canvas.width / 2 - 200, y - 30, 400, 50);

                this.ctx.strokeStyle = '#00ffff';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(this.canvas.width / 2 - 200, y - 30, 400, 50);

                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillText('‚ñ∫', this.canvas.width / 2 - 250, y);
            } else {
                this.ctx.fillStyle = '#aaaaaa';
            }

            this.ctx.fillText(`${this.games[i].icon} ${this.games[i].name}`, this.canvas.width / 2, y);
        }

        // Ï°∞Ïûë ÏïàÎÇ¥
        this.ctx.fillStyle = 'rgba(0, 255, 100, 0.8)';
        this.ctx.font = '16px monospace';
        this.ctx.fillText('[‚Üë‚Üì] ÏÑ†ÌÉù  [ENTER] ÌôïÏù∏  [ESC] ÎÇòÍ∞ÄÍ∏∞', this.canvas.width / 2, this.canvas.height - 50);
    }

    drawMemoryGame() {
        // Ï†úÎ™©
        this.ctx.fillStyle = '#ff6600';
        this.ctx.font = 'bold 28px monospace';
        this.ctx.textAlign = 'center';
        this.ctx.fillText('üß† Î©îÎ™®Î¶¨ Îß§Ïπò Í≤åÏûÑ', this.canvas.width / 2, 80);

        // ÏßÑÌñâ ÏÉÅÌô©
        this.ctx.fillStyle = '#ffffff';
        this.ctx.font = '18px monospace';
        this.ctx.fillText(`Îß§ÏπòÎêú Ïåç: ${this.memoryGame.matchedPairs} / ${this.memoryGame.totalPairs}`, this.canvas.width / 2, 120);

        // Ïπ¥ÎìúÎì§ Í∑∏Î¶¨Í∏∞
        for (let card of this.memoryGame.cards) {
            if (card.matched) {
                // Îß§ÏπòÎêú Ïπ¥Îìú
                this.ctx.fillStyle = '#228B22';
            } else if (card.flipped) {
                // Îí§ÏßëÌûå Ïπ¥Îìú
                this.ctx.fillStyle = '#4169E1';
            } else {
                // Îí§ÏßëÏñ¥ÏßÑ Ïπ¥Îìú
                this.ctx.fillStyle = '#2F4F4F';
            }

            this.ctx.fillRect(card.x, card.y, 100, 80);

            // ÌÖåÎëêÎ¶¨
            this.ctx.strokeStyle = '#ffffff';
            this.ctx.lineWidth = 2;
            this.ctx.strokeRect(card.x, card.y, 100, 80);

            // Ïπ¥Îìú ÎÇ¥Ïö©
            if (card.flipped || card.matched) {
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 32px monospace';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(card.symbol, card.x + 50, card.y + 50);
            } else {
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = 'bold 24px monospace';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('?', card.x + 50, card.y + 50);
            }
        }

        // Í≤åÏûÑ ÏôÑÎ£å Î©îÏãúÏßÄ
        if (this.memoryGame.gameWon) {
            this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

            this.ctx.fillStyle = '#FFD700';
            this.ctx.font = 'bold 36px monospace';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('üéâ Ï∂ïÌïòÌï©ÎãàÎã§! üéâ', this.canvas.width / 2, this.canvas.height / 2 - 50);

            this.ctx.fillStyle = '#ffffff';
            this.ctx.font = '20px monospace';
            this.ctx.fillText('Î™®Îì† Ïπ¥ÎìúÎ•º Îß§ÏπòÌñàÏäµÎãàÎã§!', this.canvas.width / 2, this.canvas.height / 2);
            this.ctx.fillText('[ESC] Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞', this.canvas.width / 2, this.canvas.height / 2 + 50);
        }

        // Ï°∞Ïûë ÏïàÎÇ¥
        this.ctx.fillStyle = 'rgba(0, 255, 100, 0.8)';
        this.ctx.font = '14px monospace';
        this.ctx.textAlign = 'center';
        this.ctx.fillText('[ÌÅ¥Î¶≠] Ïπ¥Îìú Îí§ÏßëÍ∏∞  [ESC] Î©îÎâ¥Î°ú', this.canvas.width / 2, this.canvas.height - 30);
    }

    drawSnakeGame() {
        // Ï†úÎ™©
        this.ctx.fillStyle = '#32CD32';
        this.ctx.font = 'bold 28px monospace';
        this.ctx.textAlign = 'center';
        this.ctx.fillText('üêç Ìú¥ÎÑ∑ Ïä§ÎÑ§Ïù¥ÌÅ¨', this.canvas.width / 2, 80);

        // Ï†êÏàò
        this.ctx.fillStyle = '#ffffff';
        this.ctx.font = '18px monospace';
        this.ctx.fillText(`Ï†êÏàò: ${this.snakeGame.score}`, this.canvas.width / 2, 120);

        // Í≤åÏûÑ ÏòÅÏó≠
        const gameArea = {
            x: 200,
            y: 150,
            width: 800,
            height: 400
        };

        // Í≤åÏûÑ ÏòÅÏó≠ Î∞∞Í≤Ω
        this.ctx.fillStyle = '#000000';
        this.ctx.fillRect(gameArea.x, gameArea.y, gameArea.width, gameArea.height);

        // Í≤åÏûÑ ÏòÅÏó≠ ÌÖåÎëêÎ¶¨
        this.ctx.strokeStyle = '#ffffff';
        this.ctx.lineWidth = 2;
        this.ctx.strokeRect(gameArea.x, gameArea.y, gameArea.width, gameArea.height);

        if (this.snakeGame.gameStarted && !this.snakeGame.gameOver) {
            // Î±Ä Í∑∏Î¶¨Í∏∞
            this.ctx.fillStyle = '#32CD32';
            for (let segment of this.snakeGame.snake) {
                this.ctx.fillRect(
                    gameArea.x + segment.x * 25 + 2,
                    gameArea.y + segment.y * 20 + 2,
                    21, 16
                );
            }

            // Î®∏Î¶¨ Í∞ïÏ°∞
            this.ctx.fillStyle = '#228B22';
            const head = this.snakeGame.snake[0];
            this.ctx.fillRect(
                gameArea.x + head.x * 25 + 2,
                gameArea.y + head.y * 20 + 2,
                21, 16
            );

            // ÏùåÏãù Í∑∏Î¶¨Í∏∞
            this.ctx.fillStyle = '#FF6347';
            this.ctx.fillRect(
                gameArea.x + this.snakeGame.food.x * 25 + 2,
                gameArea.y + this.snakeGame.food.y * 20 + 2,
                21, 16
            );
        } else if (this.snakeGame.gameOver) {
            // Í≤åÏûÑ Ïò§Î≤Ñ Î©îÏãúÏßÄ
            this.ctx.fillStyle = '#FF4500';
            this.ctx.font = 'bold 36px monospace';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('Í≤åÏûÑ Ïò§Î≤Ñ!', this.canvas.width / 2, this.canvas.height / 2 - 50);

            this.ctx.fillStyle = '#ffffff';
            this.ctx.font = '20px monospace';
            this.ctx.fillText(`ÏµúÏ¢Ö Ï†êÏàò: ${this.snakeGame.score}`, this.canvas.width / 2, this.canvas.height / 2);
            this.ctx.fillText('[ENTER] Îã§Ïãú ÏãúÏûë  [ESC] Î©îÎâ¥Î°ú', this.canvas.width / 2, this.canvas.height / 2 + 50);
        } else {
            // ÏãúÏûë Î©îÏãúÏßÄ
            this.ctx.fillStyle = '#ffffff';
            this.ctx.font = 'bold 24px monospace';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('Ïä§ÎÑ§Ïù¥ÌÅ¨ Í≤åÏûÑ', this.canvas.width / 2, this.canvas.height / 2 - 30);
            this.ctx.fillText('[ENTER] Í≤åÏûÑ ÏãúÏûë', this.canvas.width / 2, this.canvas.height / 2 + 10);
        }

        // Ï°∞Ïûë ÏïàÎÇ¥
        this.ctx.fillStyle = 'rgba(0, 255, 100, 0.8)';
        this.ctx.font = '14px monospace';
        this.ctx.textAlign = 'center';
        this.ctx.fillText('[Î∞©Ìñ•ÌÇ§] Ïù¥Îèô  [ESC] Î©îÎâ¥Î°ú', this.canvas.width / 2, this.canvas.height - 30);
    }
}